<?xml version="1.0" encoding="utf-8"?>



<mx:VBox
   xmlns:mx="http://www.adobe.com/2006/mxml"
   xmlns:controls="org.flexunit.flexui.controls.*"
   width="100%"
   verticalScrollPolicy="off"
   horizontalScrollPolicy="off"
   horizontalAlign="right"
   creationComplete="handleCreateComplete()" verticalGap="0">

   <mx:Metadata>
      [Event( name="filterChanged", type="flash.events.Event")]
      [Event( name="filterTextChanged", type="flash.events.Event")]
      [Event( name="filterResultChanged", type="flash.events.Event")]
      [Event( name="filterAssertionChanged", type="flash.events.Event")]
   </mx:Metadata>

   <mx:Script>
      <![CDATA[
         import org.flexunit.flexui.controls.FlexUnitLabels;
         import org.flexunit.flexui.controls.left.events.SearchBarEvent;
         import org.flexunit.flexui.data.filter.ITestFunctionStatus;
         import org.flexunit.flexui.data.filter.TestfFunctionStatuses;
         import org.flexunit.flexui.data.TestRunnerBasePresentationModel;

         import mx.events.SliderEvent;
         import mx.formatters.NumberFormatter;
         import mx.utils.StringUtil;

         private var _model : TestRunnerBasePresentationModel;

         public function set model( value : TestRunnerBasePresentationModel ) : void
         {
            _model = value;
         }

         public function updateFilterSectionEnable() : void
         {
            searchTextInput.enabled = _model.filterSectionEnabled;
            resultTypeComboBox.enabled = _model.filterSectionEnabled;
         }

         public function onAllTestsEnd() : void
         {
            resultTypeComboBox.selectedIndex = 1;
            
            resultTypeComboBox.invalidateProperties();            
            
            _model.filterModel.selectedTestFunctionStatus = TestfFunctionStatuses.ERRORS_AND_FAILURES;

            onSearch();
         }

         private function handleCreateComplete() : void
         {
            resultTypeComboBox.dataProvider = TestfFunctionStatuses.toArray();
            resultTypeComboBox.selectedIndex = 2;
         }
         
         private function onFilterTextChange() : void
         {
            onSearch();
            
            dispatchEvent( new SearchBarEvent( SearchBarEvent.FILTER_TEXT_CHANGED_EVENT ) );
         }
         
         private function onSearch() : void
         {
            _model.filterModel.filter = searchTextInput.text;

            searchImage.visible = searchTextInput.text.length > 0;

            _model.dataProvider.refresh();

            dispatchEvent( new SearchBarEvent( SearchBarEvent.FILTER_CHANGED_EVENT ) );
         }

         private function clearSearch() : void
         {
            if ( searchTextInput && searchTextInput.text != "" )
            {
               searchTextInput.text = "";

               onSearch();
            }
         }

         private function onResultTypeFilterChange( event : Event ) : void
         {
            var eventComboBox : ComboBox = event.target as ComboBox;

            _model.filterModel.selectedTestFunctionStatus = eventComboBox.selectedItem as ITestFunctionStatus
            
            if( eventComboBox.selectedIndex == 1 )
            {
               dispatchEvent( new SearchBarEvent( SearchBarEvent.FILTER_ASSERTION_CHANGED_EVENT ) );
            }
            else
            {
               dispatchEvent( new SearchBarEvent( SearchBarEvent.FILTER_RESULT_CHANGED_EVENT ) );
            }

            onSearch();
         }
         
      ]]>
   </mx:Script>

   <mx:HBox
      width="100%"
      verticalAlign="middle">

      <mx:Canvas>

         <controls:PromptingTextInput
            id="searchTextInput"
            styleName="flexUnitTextInput"
            verticalCenter="0"
            width="200"
            textIndent="20"
            prompt="{ FlexUnitLabels.FILTER_PROMPT }"
            toolTip="{ FlexUnitLabels.FILTER_TOOLTIP }"
            change="onFilterTextChange()"
            />
      
         <mx:Image
            source="@Embed('/assets/searchIcn.png')"
            verticalCenter="0"
            left="8"
            />
         
      </mx:Canvas>
   
      <mx:Image
         id="searchImage"
         visible="false"
         left="208"
         verticalCenter="0"
         source="@Embed('/assets/clearIcn.png')"
         buttonMode="true"
         useHandCursor="true"
         mouseChildren="false"
         click="clearSearch()"
         />
      
      <mx:Spacer
         width="100%"
         />
            
      <!-- Test Results Filter -->
        
      <mx:ComboBox
         id="resultTypeComboBox"
         styleName="flexUnitComboBox"
         verticalCenter="0"
         editable="false"
         width="130"
         right="0"
         change="onResultTypeFilterChange( event )"
         />
      
   </mx:HBox>
   
</mx:VBox>
